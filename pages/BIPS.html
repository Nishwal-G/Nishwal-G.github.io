<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>How do cells remember who they are? | DNA ‚Üí Chromatin ‚Üí BIPS</title>

  <style>
    :root{
      --bg: #050507;
      --panel: rgba(0,0,0,0.55);
      --border: rgba(255,255,255,0.14);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);

      --green: rgba(0,255,140,0.95);
      --red: rgba(255,60,60,0.92);
      --pink: rgba(255,120,200,0.70);
      --purple: rgba(190,120,255,0.92);

      --maxw: 1100px;
    }

    *{ box-sizing: border-box; }
    html, body{ height: 100%; }

    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .page{
      min-height: 100vh;
      padding: 14px;
      display:flex;
      flex-direction: column;
      gap: 14px;
      align-items: center;
    }

    /* TEXT AREA (ABOVE CANVAS) */
    .textPanel{
      width: min(var(--maxw), 100%);
      border: 1px solid var(--border);
      border-radius: 18px;
      background: rgba(0,0,0,0.46);
      backdrop-filter: blur(12px);
      box-shadow: 0 20px 80px rgba(0,0,0,0.55);
      overflow: hidden;
    }

    .textInner{ padding: 16px 16px 14px 16px; }

    .kicker{
      font-weight: 900;
      letter-spacing: 0.3px;
      font-size: 12px;
      color: rgba(255,255,255,0.70);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .sceneTitle{
      font-weight: 950;
      letter-spacing: -0.3px;
      font-size: clamp(20px, 2.2vw, 28px);
      margin: 0;
      line-height: 1.1;
    }

    .sceneSub{
      margin-top: 8px;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.55;
    }

    .storyText{
      margin-top: 12px;
      color: rgba(255,255,255,0.78);
      font-size: 15px;
      line-height: 1.72;
    }
    .storyText p{ margin: 10px 0 0 0; }

    /* Big clickable glossary-like words */
    .bigClick{
      display:inline-block;
      padding: 4px 10px;
      margin: 0 2px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      font-weight: 950;
      letter-spacing: 0.2px;
      text-transform: uppercase;
      font-size: 13px;
      color: rgba(255,255,255,0.92);
      cursor: pointer;
      user-select:none;
      transform: translateY(-1px);
    }
    .bigClick:hover{ background: rgba(255,255,255,0.11); }
    .bigClick.green{ border-color: rgba(0,255,140,0.30); color: var(--green); }
    .bigClick.purple{ border-color: rgba(190,120,255,0.35); color: var(--purple); }
    .bigClick.white{ border-color: rgba(255,255,255,0.20); color: rgba(255,255,255,0.92); }

    /* Controls */
    .controls{
      display:flex;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .pill{
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.38);
      color: rgba(255,255,255,0.90);
      padding: 9px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 900;
      font-size: 13px;
      backdrop-filter: blur(10px);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      user-select:none;
    }
    .pill:hover{ background: rgba(255,255,255,0.10); }
    .pill.strong{ background: rgba(255,255,255,0.12); }
    .pill.ghost{ background: rgba(255,255,255,0.04); }
    .pill:disabled{ opacity: 0.35; cursor: default; }

    /* ACT 2+3+4 mini buttons (Base pair / Gene / Epigenetics) */
    .miniControls{
      display:flex;
      gap: 10px;
      align-items: center;
      justify-content: flex-start;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .miniPill{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      padding: 8px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 950;
      font-size: 12px;
      letter-spacing: 0.2px;
      text-transform: uppercase;
      user-select:none;
    }
    .miniPill:hover{ background: rgba(255,255,255,0.10); }
    .miniPill.white{ border-color: rgba(255,255,255,0.20); }
    .miniPill.green{ border-color: rgba(0,255,140,0.30); color: var(--green); }
    .miniPill.purple{ border-color: rgba(190,120,255,0.35); color: var(--purple); }

    /* CANVAS PANEL */
    .stage{
      width: min(var(--maxw), 100%);
      height: min(62vh, 720px);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 18px;
      overflow: hidden;
      background: rgba(0,0,0,0.25);
      position: relative;
    }

    #stageCanvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      display:block;
      touch-action: none; /* important for pointer dragging on mobile */
    }

    /* Act-image overlay (for opening and final acts) */
    .stageImage{
      position:absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: none;
      padding: 14px;
      background: rgba(0,0,0,0.15);
    }
    .stageImage.show{ display:block; }

    /* NEW: Inline overlay panel for SVG diagrams (Act 1 + Act 4) */
    .stageOverlay{
      position:absolute;
      inset: 0;
      display: none;
      padding: 14px;
      background: rgba(0,0,0,0.15);
    }
    .stageOverlay.show{ display:block; }
    .overlayCard{
      height: 100%;
      width: 100%;
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 18px;
      background: rgba(0,0,0,0.28);
      backdrop-filter: blur(10px);
      overflow: hidden;
      display:flex;
      flex-direction: column;
    }
    .overlayHead{
      padding: 12px 14px 10px 14px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
    }
    .overlayTitle{
      font-weight: 950;
      letter-spacing: -0.2px;
      font-size: 14px;
      color: rgba(255,255,255,0.88);
    }
    .overlayHint{
      font-size: 12px;
      color: rgba(255,255,255,0.66);
    }
    .overlayBody{
      flex: 1;
      padding: 12px 14px 14px 14px;
    }
    .overlayBody svg{
      width: 100%;
      height: 100%;
      display:block;
    }

    .legend{
      position:absolute;
      left: 12px;
      bottom: 12px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: rgba(0,0,0,0.32);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,0.70);
      font-size: 12px;
      display: flex;
      gap: 10px;
      align-items: center;
      pointer-events: none;

      opacity: 0;
      transform: translateY(8px);
      transition: opacity 180ms ease, transform 180ms ease;
    }
    .legend.show{ opacity: 1; transform: translateY(0); }

    .dot{
      display:inline-block;
      width: 9px;
      height: 9px;
      border-radius: 50%;
      margin-right: 6px;
    }
    .dot.white{ background: rgba(255,255,255,0.85); }
    .dot.green{ background: var(--green); }
    .dot.red{ background: var(--red); }
    .dot.pink{ background: var(--pink); }
    .dot.purple{ background: var(--purple); }

    .dragHint{
      position:absolute;
      right: 12px;
      top: 12px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: rgba(0,0,0,0.32);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,0.78);
      font-size: 12px;
      pointer-events:none;

      opacity: 0;
      transform: translateY(-6px);
      transition: opacity 180ms ease, transform 180ms ease;
    }
    .dragHint.show{ opacity: 1; transform: translateY(0); }

    @media (max-width: 860px){
      .stage{ height: 52vh; }
    }

    /* ============================================================
       NEW: Letter / base-pair panel shown under canvas in Acts 2‚Äì3
       ============================================================ */
    .pairPanel{
      width: min(var(--maxw), 100%);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 18px;
      background: rgba(0,0,0,0.25);
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 80px rgba(0,0,0,0.35);
      overflow: hidden;
      display: none; /* toggled by JS */
    }
    .pairInner{
      padding: 12px 14px 14px 14px;
    }
    .pairTitleRow{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .pairTitle{
      font-weight: 950;
      letter-spacing: -0.2px;
      font-size: 14px;
      color: rgba(255,255,255,0.86);
    }
    .pairHint{
      font-size: 12px;
      color: rgba(255,255,255,0.66);
    }

    .pairStripWrap{
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 6px;
    }

    .pairStrip{
      display: inline-flex;
      gap: 8px;
      align-items: center;
      padding: 8px 6px;
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      background: rgba(0,0,0,0.22);
      min-height: 86px;
    }

    .bp{
      width: 34px;
      height: 70px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      position: relative;
      display:flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      user-select:none;
      flex: 0 0 auto;
    }

    .bp .top, .bp .bot{
      width: 100%;
      text-align: center;
      font-weight: 950;
      font-size: 18px;
      line-height: 1.0;
      letter-spacing: 0.4px;
      color: rgba(255,255,255,0.86);
      text-shadow: 0 0 18px rgba(255,255,255,0.12);
    }
    .bp .bot{
      margin-top: 14px;
      color: rgba(255,255,255,0.76);
    }

    /* connector ‚Äúrung‚Äù */
    .bp::after{
      content:"";
      position:absolute;
      left: 50%;
      top: 29px;
      transform: translateX(-50%);
      width: 2px;
      height: 12px;
      border-radius: 99px;
      background: rgba(255,255,255,0.20);
      box-shadow: 0 0 16px rgba(255,255,255,0.10);
    }

    /* Active single base-pair highlight (Base pairs button / bigClick) */
    .bp.active{
      border-color: rgba(255,255,255,0.30);
      background: rgba(255,255,255,0.10);
      box-shadow: 0 0 0 2px rgba(255,255,255,0.06) inset, 0 16px 60px rgba(255,255,255,0.05);
    }
    .bp.active .top, .bp.active .bot{
      color: rgba(255,255,255,0.95);
      text-shadow: 0 0 22px rgba(255,255,255,0.22);
    }
    .bp.active::after{
      background: rgba(255,255,255,0.85);
      box-shadow: 0 0 22px rgba(255,255,255,0.35);
    }

    /* Gene region highlight (Gene button / bigClick) */
    .bp.gene{
      border-color: rgba(0,255,140,0.30);
      background: rgba(0,255,140,0.07);
    }
    .bp.gene .top, .bp.gene .bot{
      color: rgba(0,255,140,0.92);
      text-shadow: 0 0 24px rgba(0,255,140,0.22);
    }
    .bp.gene::after{
      background: rgba(0,255,140,0.72);
      box-shadow: 0 0 22px rgba(0,255,140,0.25);
    }

    /* tiny legend chips */
    .pairChips{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      color: rgba(255,255,255,0.72);
      font-weight: 850;
      font-size: 12px;
      user-select:none;
    }
    .chip .swatch{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.60);
      box-shadow: 0 0 14px rgba(255,255,255,0.12);
    }
    .chip.green .swatch{
      background: rgba(0,255,140,0.85);
      box-shadow: 0 0 18px rgba(0,255,140,0.18);
    }
  </style>
</head>

<body>
  <div class="page">
    <section class="textPanel" aria-label="Story text">
      <div class="textInner">
        <div class="kicker" id="kicker">Interactive story (8 acts)</div>

        <h1 class="sceneTitle" id="sceneTitle">Opening ‚Äî How do cells remember who they are?</h1>

        <div class="sceneSub" id="sceneSub">
          Read the story, then look at the animation underneath. Use Next / Prev to move through the acts.
        </div>

        <div class="storyText" id="storyText"></div>

        <!-- Mini buttons: shown for Act 2 (DNA), Act 3 (Gene), Act 4 (Epigenetics) only -->
        <div class="miniControls" id="dnaButtons" style="display:none;">
          <button class="miniPill white" id="btnBasepair" type="button">Base pairs</button>
          <button class="miniPill green" id="btnGene" type="button">Gene</button>
          <button class="miniPill purple" id="btnEpi" type="button">Epigenetics</button>
        </div>

        <div class="controls">
          <button class="pill ghost" id="prevBtn" type="button">‚Üê Prev</button>
          <button class="pill ghost" id="resetBtn" type="button" title="Reset this act">‚Üª Reset</button>
          <button class="pill strong" id="nextBtn" type="button">Next ‚Üí</button>
        </div>
      </div>
    </section>

    <section class="stage" aria-label="Animation canvas">
      <canvas id="stageCanvas"></canvas>

      <!-- images for opening + final -->
      <img id="stageImage" class="stageImage" alt="Act image"/>

      <!-- NEW: SVG overlays (Act 1 flowchart + Act 4 DNA->chromatin) -->
      <div class="stageOverlay" id="stageOverlay">
        <div class="overlayCard">
          <div class="overlayHead">
            <div class="overlayTitle" id="overlayTitle">Story map</div>
            <div class="overlayHint" id="overlayHint">A quick overview</div>
          </div>
          <div class="overlayBody" id="overlayBody">
            <!-- SVG injected by JS -->
          </div>
        </div>
      </div>

      <div class="dragHint" id="dragHint">Act 6: drag the big TF (red)</div>

      <div class="legend" id="legend">
        <span class="dot white"></span> chromatin
        <span class="dot green"></span> gene / active region
        <span class="dot red"></span> TF (reader)
        <span class="dot pink"></span> hub / factory
        <span class="dot purple"></span> locked DNA
      </div>
    </section>

    <!-- ============================================================
         NEW: ATCG + pairing panel under the canvas (Acts 2‚Äì3 only)
         ============================================================ -->
    <section class="pairPanel" id="pairPanel" aria-label="DNA letters and base-pairing">
      <div class="pairInner">
        <div class="pairTitleRow">
          <div class="pairTitle">DNA as letters (A, C, G, T) with base-pairing</div>
          <div class="pairHint">A‚ÜîT and C‚ÜîG</div>
        </div>

        <div class="pairStripWrap">
          <div class="pairStrip" id="pairStrip"></div>
        </div>

        <div class="pairChips" aria-hidden="true">
          <span class="chip"><span class="swatch"></span> base pair (click ‚ÄúBase pairs‚Äù)</span>
          <span class="chip green"><span class="swatch"></span> gene region (click ‚ÄúGene‚Äù)</span>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ============================================================
    // Canvas setup
    // ============================================================
    const canvas = document.getElementById("stageCanvas");
    const ctx = canvas.getContext("2d");

    const stageImage = document.getElementById("stageImage");
    const stageOverlay = document.getElementById("stageOverlay");
    const overlayTitle = document.getElementById("overlayTitle");
    const overlayHint  = document.getElementById("overlayHint");
    const overlayBody  = document.getElementById("overlayBody");

    function resizeCanvas() {
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      const rect = canvas.getBoundingClientRect();
      const w = Math.floor(rect.width * dpr);
      const h = Math.floor(rect.height * dpr);
      if (canvas.width !== w || canvas.height !== h) {
        canvas.width = w;
        canvas.height = h;
      }
      return { w: canvas.width, h: canvas.height, dpr };
    }

    // RNG helpers
    function randn() {
      let u=0, v=0;
      while(u===0) u=Math.random();
      while(v===0) v=Math.random();
      return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
    }
    function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }

    // ============================================================
    // UI
    // ============================================================
    const sceneTitle = document.getElementById("sceneTitle");
    const sceneSub   = document.getElementById("sceneSub");
    const storyText  = document.getElementById("storyText");
    const kicker     = document.getElementById("kicker");

    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const resetBtn = document.getElementById("resetBtn");

    const legend = document.getElementById("legend");
    const dragHint = document.getElementById("dragHint");

    const dnaButtons = document.getElementById("dnaButtons");
    const btnBasepair = document.getElementById("btnBasepair");
    const btnGene = document.getElementById("btnGene");
    const btnEpi = document.getElementById("btnEpi");

    // ============================================================
    // NEW: Letter / base-pair strip under the canvas (Acts 2‚Äì3)
    // ============================================================
    const pairPanel = document.getElementById("pairPanel");
    const pairStrip = document.getElementById("pairStrip");

    const DNA_SEQ = "ATGCCATGTTACCGTACGATTCGAGCTAATCG";
    function complement(base){
      if (base === "A") return "T";
      if (base === "T") return "A";
      if (base === "C") return "G";
      if (base === "G") return "C";
      return "?";
    }

    const STRIP_GENE_START = 10;
    const STRIP_GENE_END   = 19;
    const STRIP_BASEPAIR_INDEX = 6;

    function buildPairStrip(){
      pairStrip.innerHTML = "";
      for (let i=0; i<DNA_SEQ.length; i++){
        const top = DNA_SEQ[i];
        const bot = complement(top);

        const bp = document.createElement("div");
        bp.className = "bp";
        bp.dataset.idx = String(i);

        const t = document.createElement("div");
        t.className = "top";
        t.textContent = top;

        const b = document.createElement("div");
        b.className = "bot";
        b.textContent = bot;

        bp.appendChild(t);
        bp.appendChild(b);
        pairStrip.appendChild(bp);
      }
    }

    function updatePairStrip(){
      const show = (actIndex === 1 || actIndex === 2);
      pairPanel.style.display = show ? "block" : "none";
      if (!show) return;

      const nodes = pairStrip.querySelectorAll(".bp");
      nodes.forEach(n => { n.classList.remove("active"); n.classList.remove("gene"); });

      if (highlight === "basepair"){
        const el = pairStrip.querySelector(`.bp[data-idx="${STRIP_BASEPAIR_INDEX}"]`);
        if (el) el.classList.add("active");
      }
      if (highlight === "gene"){
        for (let i=STRIP_GENE_START; i<=STRIP_GENE_END; i++){
          const el = pairStrip.querySelector(`.bp[data-idx="${i}"]`);
          if (el) el.classList.add("gene");
        }
      }
    }

    buildPairStrip();

    // ============================================================
    // NEW: SVG diagrams for Act 1 and Act 4
    // ============================================================
    function flowchartSVG(){
      // Crisp, self-contained story map (no external images).
      return `
<svg viewBox="0 0 1100 620" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Story flowchart">
  <defs>
    <linearGradient id="gBg" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="rgba(255,255,255,0.04)"/>
      <stop offset="1" stop-color="rgba(255,255,255,0.01)"/>
    </linearGradient>

    <filter id="softGlow" x="-30%" y="-30%" width="160%" height="160%">
      <feGaussianBlur stdDeviation="10" result="blur"/>
      <feColorMatrix type="matrix" values="
        1 0 0 0 0
        0 1 0 0 0
        0 0 1 0 0
        0 0 0 0.45 0" result="glow"/>
      <feMerge>
        <feMergeNode in="glow"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>

    <marker id="arrow" markerWidth="14" markerHeight="14" refX="11" refY="7" orient="auto">
      <path d="M0,0 L14,7 L0,14 Z" fill="rgba(255,255,255,0.55)"/>
    </marker>

    <style>
      .card{ fill: rgba(0,0,0,0.26); stroke: rgba(255,255,255,0.14); stroke-width: 2; }
      .title{ font: 900 22px system-ui, -apple-system, Segoe UI, Roboto, Arial; fill: rgba(255,255,255,0.92); }
      .sub{ font: 650 14px system-ui, -apple-system, Segoe UI, Roboto, Arial; fill: rgba(255,255,255,0.72); }
      .tag{ font: 900 12px system-ui, -apple-system, Segoe UI, Roboto, Arial; letter-spacing: .22em; text-transform: uppercase; fill: rgba(255,255,255,0.62); }
      .arrow{ stroke: rgba(255,255,255,0.42); stroke-width: 3; fill: none; marker-end: url(#arrow); }
      .dotW{ fill: rgba(255,255,255,0.85); }
      .dotG{ fill: rgba(0,255,140,0.90); }
      .dotP{ fill: rgba(190,120,255,0.90); }
      .dotR{ fill: rgba(255,60,60,0.86); }
      .dotK{ fill: rgba(255,120,200,0.70); }
      .mini{ font: 800 13px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New"; fill: rgba(255,255,255,0.80); }
    </style>
  </defs>

  <!-- background -->
  <rect x="0" y="0" width="1100" height="620" rx="22" fill="url(#gBg)"/>

  <!-- Top banner -->
  <text x="46" y="68" class="tag">The story in one picture</text>
  <text x="46" y="104" class="title">Same DNA ‚Üí different cell types</text>
  <text x="46" y="132" class="sub">Identity is ‚Äúwhich genes are read‚Äù, and 3D folding helps stabilise that choice.</text>

  <!-- Cards -->
  <g filter="url(#softGlow)">
    <!-- Card 1 -->
    <rect x="46" y="170" width="300" height="150" rx="18" class="card"/>
    <circle cx="82" cy="214" r="8" class="dotW"/>
    <text x="102" y="220" class="mini">DNA letters (A C G T)</text>
    <text x="82" y="255" class="sub">Information is stored as base pairs</text>
    <text x="82" y="280" class="sub">Genes are stretches you can read</text>

    <!-- Card 2 -->
    <rect x="400" y="170" width="300" height="150" rx="18" class="card"/>
    <circle cx="436" cy="214" r="8" class="dotP"/>
    <text x="456" y="220" class="mini">Epigenetic ‚Äúlocks‚Äù</text>
    <text x="436" y="255" class="sub">Some regions become harder to access</text>
    <text x="436" y="280" class="sub">Helps keep the ‚Äúwrong chapters‚Äù quiet</text>

    <!-- Card 3 -->
    <rect x="754" y="170" width="300" height="150" rx="18" class="card"/>
    <circle cx="790" cy="214" r="8" class="dotW"/>
    <text x="810" y="220" class="mini">DNA ‚Üí chromatin (polymer)</text>
    <text x="790" y="255" class="sub">DNA is a 3D object that folds & moves</text>
    <text x="790" y="280" class="sub">Folding changes who meets whom</text>
  </g>

  <!-- arrows between top cards -->
  <path d="M346 245 C372 245, 374 245, 398 245" class="arrow"/>
  <path d="M700 245 C726 245, 728 245, 752 245" class="arrow"/>

  <!-- Bottom row -->
  <g filter="url(#softGlow)">
    <!-- TFs -->
    <rect x="150" y="370" width="360" height="190" rx="18" class="card"/>
    <circle cx="186" cy="414" r="8" class="dotR"/>
    <text x="206" y="420" class="mini">Transcription factors (TFs)</text>
    <text x="186" y="455" class="sub">TFs wander, then bind to specific sites</text>
    <text x="186" y="480" class="sub">Multivalent TFs can act like sticky hubs</text>

    <!-- BIPS / factories -->
    <rect x="590" y="370" width="360" height="190" rx="18" class="card"/>
    <circle cx="626" cy="414" r="8" class="dotK"/>
    <text x="646" y="420" class="mini">BIPS / transcription factories</text>
    <text x="626" y="455" class="sub">A dense hub attracts more TFs (rich-get-richer)</text>
    <text x="626" y="480" class="sub">3D structure biases which genes stay active</text>
    <text x="626" y="505" class="sub">‚Üí a physical route to stable identity (memory)</text>

    <!-- little ‚Äúhub‚Äù doodle -->
    <circle cx="902" cy="487" r="52" fill="rgba(255,120,200,0.10)" stroke="rgba(255,120,200,0.22)" stroke-width="2"/>
    <circle cx="902" cy="487" r="18" class="dotR"/>
    <circle cx="866" cy="458" r="10" class="dotR" opacity="0.55"/>
    <circle cx="940" cy="458" r="10" class="dotR" opacity="0.55"/>
    <circle cx="866" cy="516" r="10" class="dotR" opacity="0.55"/>
    <circle cx="940" cy="516" r="10" class="dotR" opacity="0.55"/>
  </g>

  <!-- arrows down -->
  <path d="M550 320 C550 338, 550 342, 330 370" class="arrow" opacity="0.8"/>
  <path d="M550 320 C550 340, 550 345, 770 370" class="arrow" opacity="0.8"/>

  <!-- Footer -->
  <text x="46" y="602" class="sub">Use Next ‚Üí to step through each piece, then watch the physics happen in the animations.</text>
</svg>
      `;
    }

    function dnaToChromatinSVG(){
      // A cartoon: DNA helix wraps around histones -> nucleosomes -> fiber -> polymer chain
      return `
<svg viewBox="0 0 1100 620" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="DNA to chromatin diagram">
  <defs>
    <linearGradient id="bg2" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="rgba(255,255,255,0.04)"/>
      <stop offset="1" stop-color="rgba(255,255,255,0.01)"/>
    </linearGradient>
    <filter id="glow2" x="-30%" y="-30%" width="160%" height="160%">
      <feGaussianBlur stdDeviation="10" result="b"/>
      <feMerge>
        <feMergeNode in="b"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
    <marker id="arr2" markerWidth="14" markerHeight="14" refX="11" refY="7" orient="auto">
      <path d="M0,0 L14,7 L0,14 Z" fill="rgba(255,255,255,0.55)"/>
    </marker>
    <style>
      .panel{ fill: rgba(0,0,0,0.22); stroke: rgba(255,255,255,0.12); stroke-width: 2; }
      .title{ font: 950 22px system-ui, -apple-system, Segoe UI, Roboto, Arial; fill: rgba(255,255,255,0.92); }
      .sub{ font: 650 14px system-ui, -apple-system, Segoe UI, Roboto, Arial; fill: rgba(255,255,255,0.72); }
      .tag{ font: 900 12px system-ui, -apple-system, Segoe UI, Roboto, Arial; letter-spacing: .22em; text-transform: uppercase; fill: rgba(255,255,255,0.62); }
      .arrow{ stroke: rgba(255,255,255,0.42); stroke-width: 3; fill: none; marker-end: url(#arr2); }
      .dna{ stroke: rgba(255,255,255,0.75); stroke-width: 3; fill: none; }
      .dnaDim{ stroke: rgba(255,255,255,0.22); stroke-width: 3; fill: none; }
      .hist{ fill: rgba(255,60,60,0.20); stroke: rgba(255,60,60,0.55); stroke-width: 2; }
      .nuc{ fill: rgba(255,120,200,0.10); stroke: rgba(255,120,200,0.28); stroke-width: 2; }
      .fiber{ stroke: rgba(255,255,255,0.26); stroke-width: 10; fill: none; stroke-linecap: round; }
      .fiber2{ stroke: rgba(255,255,255,0.60); stroke-width: 3; fill: none; stroke-linecap: round; }
      .bead{ fill: rgba(255,255,255,0.55); }
      .bead2{ fill: rgba(255,255,255,0.85); }
      .beadG{ fill: rgba(0,255,140,0.78); }
    </style>
  </defs>

  <rect x="0" y="0" width="1100" height="620" rx="22" fill="url(#bg2)"/>

  <text x="46" y="68" class="tag">DNA ‚Üí chromatin (the physical link)</text>
  <text x="46" y="104" class="title">DNA wraps around histones, then folds into chromatin</text>
  <text x="46" y="132" class="sub">This is why we can model chromatin as a moving polymer chain in later acts.</text>

  <!-- Panels -->
  <g filter="url(#glow2)">
    <rect x="46" y="170" width="320" height="390" rx="18" class="panel"/>
    <rect x="390" y="170" width="320" height="390" rx="18" class="panel"/>
    <rect x="734" y="170" width="320" height="390" rx="18" class="panel"/>
  </g>

  <!-- Labels -->
  <text x="72" y="206" class="title" style="font-size:18px;">1) DNA double helix</text>
  <text x="416" y="206" class="title" style="font-size:18px;">2) Nucleosomes</text>
  <text x="760" y="206" class="title" style="font-size:18px;">3) Chromatin fiber</text>

  <text x="72" y="236" class="sub">Letters live on a helix.</text>
  <text x="416" y="236" class="sub">DNA wraps around histone proteins.</text>
  <text x="760" y="236" class="sub">Packed & folded ‚Üí a polymer-like chain.</text>

  <!-- Panel 1: stylised helix -->
  <g transform="translate(70,260)">
    <!-- back strand -->
    <path class="dnaDim" d="M40,0 C120,40 120,120 40,160 C-40,200 -40,280 40,320 C120,360 120,440 40,480" />
    <!-- front strand -->
    <path class="dna" d="M120,0 C40,40 40,120 120,160 C200,200 200,280 120,320 C40,360 40,440 120,480" />
    <!-- rungs -->
    <g opacity="0.55">
      <line x1="55" y1="20" x2="105" y2="20" stroke="rgba(255,255,255,0.35)" stroke-width="2"/>
      <line x1="50" y1="60" x2="110" y2="60" stroke="rgba(255,255,255,0.35)" stroke-width="2"/>
      <line x1="55" y1="100" x2="105" y2="100" stroke="rgba(255,255,255,0.35)" stroke-width="2"/>
      <line x1="50" y1="140" x2="110" y2="140" stroke="rgba(255,255,255,0.35)" stroke-width="2"/>
      <line x1="55" y1="180" x2="105" y2="180" stroke="rgba(255,255,255,0.35)" stroke-width="2"/>
      <line x1="50" y1="220" x2="110" y2="220" stroke="rgba(255,255,255,0.35)" stroke-width="2"/>
      <line x1="55" y1="260" x2="105" y2="260" stroke="rgba(255,255,255,0.35)" stroke-width="2"/>
      <line x1="50" y1="300" x2="110" y2="300" stroke="rgba(255,255,255,0.35)" stroke-width="2"/>
      <line x1="55" y1="340" x2="105" y2="340" stroke="rgba(255,255,255,0.35)" stroke-width="2"/>
      <line x1="50" y1="380" x2="110" y2="380" stroke="rgba(255,255,255,0.35)" stroke-width="2"/>
      <line x1="55" y1="420" x2="105" y2="420" stroke="rgba(255,255,255,0.35)" stroke-width="2"/>
      <line x1="50" y1="460" x2="110" y2="460" stroke="rgba(255,255,255,0.35)" stroke-width="2"/>
    </g>

    <text x="10" y="520" class="sub" style="font-size:13px;">(base pairs are the ‚Äúrungs‚Äù)</text>
  </g>

  <!-- Arrow 1 -->
  <path d="M366 365 C382 365, 378 365, 388 365" class="arrow"/>

  <!-- Panel 2: nucleosomes (beads on a string) -->
  <g transform="translate(410,270)">
    <!-- DNA string -->
    <path d="M10,240 C90,190 150,290 230,240 C290,205 320,250 340,260" stroke="rgba(255,255,255,0.35)" stroke-width="4" fill="none" stroke-linecap="round"/>

    <!-- nucleosome cores -->
    <g>
      <circle cx="70" cy="220" r="44" class="nuc"/>
      <circle cx="170" cy="250" r="44" class="nuc"/>
      <circle cx="270" cy="230" r="44" class="nuc"/>
    </g>

    <!-- histone cores -->
    <g>
      <circle cx="70" cy="220" r="18" class="hist"/>
      <circle cx="170" cy="250" r="18" class="hist"/>
      <circle cx="270" cy="230" r="18" class="hist"/>
    </g>

    <!-- DNA wraps (spirals) -->
    <g fill="none" stroke-linecap="round">
      <path d="M35,220 C45,195 95,195 105,220 C115,245 65,255 55,235 C45,215 85,210 95,232" stroke="rgba(255,255,255,0.55)" stroke-width="3"/>
      <path d="M135,250 C145,225 195,225 205,250 C215,275 165,285 155,265 C145,245 185,240 195,262" stroke="rgba(255,255,255,0.55)" stroke-width="3"/>
      <path d="M235,230 C245,205 295,205 305,230 C315,255 265,265 255,245 C245,225 285,220 295,242" stroke="rgba(255,255,255,0.55)" stroke-width="3"/>
    </g>

    <text x="0" y="40" class="sub" style="font-size:13px;">Histone proteins (red cores) act like spools.</text>
    <text x="0" y="62" class="sub" style="font-size:13px;">DNA wraps around them ‚Üí ‚Äúbeads on a string‚Äù.</text>
  </g>

  <!-- Arrow 2 -->
  <path d="M710 365 C726 365, 722 365, 732 365" class="arrow"/>

  <!-- Panel 3: chromatin fiber + polymer beads -->
  <g transform="translate(752,270)">
    <!-- thick fiber -->
    <path class="fiber" d="M20,250 C70,190 120,310 170,250 C220,190 270,310 320,250"/>
    <!-- thin fiber highlight -->
    <path class="fiber2" d="M20,250 C70,190 120,310 170,250 C220,190 270,310 320,250" opacity="0.55"/>

    <!-- polymer beads along fiber -->
    <circle cx="35" cy="238" r="6" class="bead2"/>
    <circle cx="70" cy="210" r="6" class="bead"/>
    <circle cx="105" cy="248" r="6" class="bead2"/>
    <circle cx="140" cy="290" r="6" class="bead"/>
    <circle cx="170" cy="250" r="6" class="bead2"/>
    <circle cx="205" cy="210" r="6" class="bead"/>
    <circle cx="240" cy="250" r="6" class="bead2"/>
    <circle cx="275" cy="292" r="6" class="bead"/>
    <circle cx="320" cy="250" r="6" class="bead2"/>

    <!-- ‚Äúactive region‚Äù bead -->
    <circle cx="205" cy="210" r="8" class="beadG"/>

    <text x="0" y="40" class="sub" style="font-size:13px;">Now it‚Äôs a packed, flexible chain.</text>
    <text x="0" y="62" class="sub" style="font-size:13px;">That‚Äôs why polymer models make sense.</text>
    <text x="0" y="84" class="sub" style="font-size:13px;">(green bead = ‚Äúgene region‚Äù)</text>
  </g>

  <!-- Footer -->
  <text x="46" y="602" class="sub">In Act 4 you‚Äôll interact with a polymer cartoon of chromatin (a coarse-grained version of this).</text>
</svg>
      `;
    }

    function updateStageOverlay(){
      // Show overlay only for Act 1 (flowchart) and Act 4 (DNA->chromatin)
      // Act 1 is index 0, Act 4 is index 4.
      const show = (actIndex === 0 || actIndex === 4);

      stageOverlay.classList.toggle("show", show);
      if (!show) {
        overlayBody.innerHTML = "";
        return;
      }

      if (actIndex === 0){
        overlayTitle.textContent = "Story map";
        overlayHint.textContent  = "What you‚Äôre about to see";
        overlayBody.innerHTML = flowchartSVG();
      } else if (actIndex === 4){
        overlayTitle.textContent = "DNA ‚Üí chromatin";
        overlayHint.textContent  = "How the helix becomes a polymer";
        overlayBody.innerHTML = dnaToChromatinSVG();
      }
    }

    // ============================================================
    // Clickable words (text) + click-to-highlight (DNA)
    // ============================================================
    let highlight = null; // "basepair" | "gene" | "epi" | null

    function bigWord(label, cssClass, onClickId){
      return `<span class="bigClick ${cssClass}" data-click="${onClickId}">${label}</span>`;
    }

    document.addEventListener("click", (e) => {
      const el = e.target.closest("[data-click]");
      if (!el) return;
      const id = el.getAttribute("data-click");
      if (id === "basepair") highlight = (highlight === "basepair") ? null : "basepair";
      if (id === "gene") highlight = (highlight === "gene") ? null : "gene";
      if (id === "epi") highlight = (highlight === "epi") ? null : "epi";
      updatePairStrip();
    });

    // Buttons for DNA/Gene/Epi acts
    btnBasepair.addEventListener("click", () => {
      highlight = (highlight === "basepair") ? null : "basepair";
      updatePairStrip();
    });
    btnGene.addEventListener("click", () => {
      highlight = (highlight === "gene") ? null : "gene";
      updatePairStrip();
    });
    btnEpi.addEventListener("click", () => {
      highlight = (highlight === "epi") ? null : "epi";
      updatePairStrip();
    });

    // ============================================================
    // Acts
    // ============================================================
    let actIndex = 0;
    let mode = "dna"; // dna | epi | act4 | act5 | act6 | act7 | act8_img

    const ACTS = [
      {
        mode: "act1_overlay",
        title: "How do cells know who they are?",
        sub: "A story about information, locks, and 3D physics.",
        html: `
          <p>
            A skin cell, a neuron, and a blood cell usually contain the <strong>same DNA</strong>. Yet they do totally different jobs.
          </p>
          <p>
            The big idea is: <strong>cell identity</strong> is mostly about <em>which parts of DNA get read</em> and which parts stay quiet.
            If different ‚Äúchapters‚Äù get used, you get different cell types.
          </p>
          <p>
            In this story we add one more layer:
            DNA isn‚Äôt just a code ‚Äî it‚Äôs also a <strong>3D object</strong> that folds and moves. That folding can help stabilise identity.
          </p>
        `,
        showLegend: false
      },
      {
        mode: "dna",
        title: "What is DNA?",
        sub: "DNA is information written in a simple alphabet ‚Äî and arranged in a famous shape.",
        html: `
          <p>
            DNA is a long molecule that stores biological information using just four ‚Äúletters‚Äù:
            <strong>A</strong>, <strong>C</strong>, <strong>G</strong>, and <strong>T</strong>.
            (Books use 26 letters ‚Äî life gets a lot done with 4.)
          </p>
          <p>
            DNA is shaped like a twisted ladder called the <strong>double helix</strong>.
            Each rung is a matched pair of letters: A pairs with T, and C pairs with G.
            Those rungs are called <strong>base pairs</strong>.
          </p>
          <p>
            Click the button below to highlight what a <strong>base pair</strong> looks like on the helix.
          </p>
        `,
        showLegend: false
      },
      {
        mode: "dna",
        title: "What is a gene?",
        sub: "If base pairs are letters, genes are meaningful ‚Äúsentences‚Äù the cell can read.",
        html: `
          <p>
            If <strong>base pairs</strong> are the letters, a <strong>gene</strong> is like a sentence (or recipe) inside the DNA book.
          </p>
          <p>
            When a cell ‚Äúreads‚Äù a gene, it makes an RNA copy and often uses that to build proteins ‚Äî the molecules that do work in the cell.
          </p>
          <p>
            Different cell types read different genes. That‚Äôs a huge part of how cells keep their identities.
            Click the <strong>Gene</strong> button to highlight one gene-sized region on the helix.
          </p>
        `,
        showLegend: false
      },
      {
        mode: "epi",
        title: "Epigenetics: locking some regions",
        sub: "Cells can keep the ‚Äòwrong‚Äô chapters harder to access ‚Äî to stay the same kind of cell.",
        html: `
          <p>
            Cells use <strong>epigenetics</strong> to help keep some DNA regions ‚Äúclosed‚Äù and others more ‚Äúopen‚Äù.
            You can think of it like placing locks and sticky notes in the DNA book: some chapters become hard to open.
          </p>
          <p>
            In the animation, locked regions glow in <span style="color: rgba(190,120,255,0.95); font-weight:900;">purple</span>.
            Click the <strong>Epigenetics</strong> button to highlight those locked sections.
          </p>
          <p>
            Epigenetics is one way identity stays stable. But there‚Äôs another ingredient:
            DNA also has <strong>physics</strong> ‚Äî it folds in 3D.
          </p>
        `,
        showLegend: false
      },
      {
        mode: "act4",
        title: "DNA is not a straight line ‚Äî it folds in 3D",
        sub: "Zoom out: DNA wraps around proteins and becomes chromatin, a flexible polymer in the nucleus.",
        html: `
          <p>
            DNA is extremely long (about <strong>2 metres</strong> per cell if stretched out), but the nucleus is tiny.
            So DNA wraps around proteins and folds into <strong>chromatin</strong>.
          </p>
          <p>
            The diagram below shows the physical link: <strong>DNA ‚Üí nucleosomes (histones) ‚Üí chromatin fiber</strong>.
            Physicists then coarse-grain this into a flexible chain (a <strong>polymer</strong>) of beads.
          </p>
          <p>
            <strong>Try it:</strong> drag the chain and fold it over itself. Let go and it will keep wiggling.
          </p>
        `,
        showLegend: true
      },
      {
        mode: "act5",
        title: "The book readers: transcription factors (TFs)",
        sub: "TFs drift around randomly. Before ‚Äústicking‚Äù, they have to find the right place.",
        html: `
          <p>
            The molecules that help ‚Äúread‚Äù genes include proteins called <strong>transcription factors</strong> (TFs).
            They move around the nucleus, bumping and drifting ‚Äî a bit like dust in the air.
          </p>
          <p>
            In this act, TFs (red) mostly wander. The chromatin chain is present, but nothing is pulling it together yet.
          </p>
        `,
        showLegend: true
      },
      {
        mode: "act6",
        title: "Sticky hubs: multivalent binding increases local density",
        sub: "A multivalent TF can bind in multiple places ‚Äî making it act like a hub that pulls chromatin in.",
        html: `
          <p>
            Some TFs are <strong>multivalent</strong>: they can bind at more than one point.
            That makes them act like a sticky hub that can pull in nearby chromatin.
          </p>
          <p>
            <strong>Drag the big red TF</strong>. The chromatin will slowly wrap around it, making a dense region.
          </p>
        `,
        showLegend: true
      },
      {
        mode: "act7",
        title: "Recruitment to a dense region",
        sub: "Once a dense region exists, more TFs are more likely to arrive there ‚Äî leaving other regions quieter.",
        html: `
          <p>
            If chromatin is denser in one region, TFs bump into that region more often ‚Äî so they tend to accumulate there.
            That can create a ‚Äúrich get richer‚Äù effect: <strong>density attracts readers</strong>.
          </p>
          <p>
            Here the chromatin is <strong>already wrapped</strong> around the main TF (a high-density hub),
            and additional TFs drift <strong>slowly</strong> toward it.
          </p>
        `,
        showLegend: true
      },
      {
        mode: "act8_img",
        title: "Transcription factories",
        sub: "A summary picture: active hubs (‚Äòfactories‚Äô) and quieter regions.",
        html: `
          <p>
            Dense hubs where many TFs gather are often called <strong>transcription factories</strong>.
            If most readers are pulled into a few hubs, other regions can be left relatively quiet.
          </p>
          <p>
            That means 3D structure isn‚Äôt just ‚Äúpacking‚Äù ‚Äî it can help bias which genes get read, and help stabilise a cell‚Äôs identity.
          </p>
        `,
        showLegend: false
      }
    ];

    function applyAct(i){
      actIndex = clamp(i, 0, ACTS.length - 1);
      const A = ACTS[actIndex];

      mode = A.mode;
      highlight = null;

      kicker.textContent = `Act ${actIndex + 1} of ${ACTS.length}`;
      sceneTitle.textContent = A.title;
      sceneSub.textContent = A.sub;
      storyText.innerHTML = A.html;

      prevBtn.disabled = (actIndex === 0);
      nextBtn.disabled = (actIndex === ACTS.length - 1);

      // Reset only for acts 4‚Äì7
      resetBtn.style.display = (mode === "act4" || mode === "act5" || mode === "act6" || mode === "act7") ? "inline-flex" : "none";

      dragHint.classList.toggle("show", mode === "act6");

      if (A.showLegend) legend.classList.add("show");
      else legend.classList.remove("show");

      // Mini buttons visibility logic:
      const showMini = (mode === "dna" || mode === "epi");
      dnaButtons.style.display = showMini ? "flex" : "none";

      btnBasepair.style.display = "none";
      btnGene.style.display = "none";
      btnEpi.style.display = "none";

      if (actIndex === 1) { // "What is DNA?"
        btnBasepair.style.display = "inline-block";
      } else if (actIndex === 2) { // "What is a gene?"
        btnBasepair.style.display = "inline-block";
        btnGene.style.display = "inline-block";
      } else if (actIndex === 3) { // "Epigenetics"
        btnEpi.style.display = "inline-block";
      }

      // Image overlay logic (final act only now)
      if (mode === "act8_img") {
        stageImage.src = "assets/bips.png";
        stageImage.classList.add("show");
        canvas.style.display = "none";
      } else {
        stageImage.classList.remove("show");
        stageImage.removeAttribute("src");
        canvas.style.display = "block";
      }

      // NEW: stage overlay (Act 1 and Act 4)
      updateStageOverlay();

      // NEW: update the letter strip visibility (Acts 2‚Äì3 only)
      updatePairStrip();

      initActWorld(true);
    }

    prevBtn.addEventListener("click", () => applyAct(actIndex - 1));
    nextBtn.addEventListener("click", () => applyAct(actIndex + 1));
    resetBtn.addEventListener("click", () => initActWorld(true));

    // ============================================================
    // Drawing helpers
    // ============================================================
    function drawBackground(){
      ctx.fillStyle = "#050507";
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = "rgba(255,255,255,0.035)";
      for (let i=0;i<140;i++){
        const x=(i*97)%canvas.width;
        const y=(i*181)%canvas.height;
        ctx.fillRect(x,y,2,2);
      }
    }

    function glowCircle(x,y,r,color,blur=18){
      ctx.save();
      ctx.shadowColor = color;
      ctx.shadowBlur = blur;
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.arc(x,y,r,0,Math.PI*2);
      ctx.fill();
      ctx.restore();
    }

    function roundRect(x, y, w, h, r, fill, stroke){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
      if (fill) ctx.fill();
      if (stroke) ctx.stroke();
    }

    // ============================================================
    // DNA helix (acts: dna + epi)
    // ============================================================
    function drawDNAHelix(){
      const W = canvas.width, H = canvas.height;
      const cx = W * 0.52;
      const cy = H * 0.56;
      const amp = H * 0.14;
      const pitch = W * 0.022;
      const turns = 44;
      const tNow = performance.now() * 0.0016;

      const baseHi = (highlight === "basepair");
      const geneHi = (highlight === "gene");
      const epiHi  = (highlight === "epi");

      const geneStart = 15;
      const geneEnd   = 24;

      const lockSegments = [
        { a: 7,  b: 12 },
        { a: 28, b: 33 }
      ];

      function isLocked(i){
        for (const seg of lockSegments){
          if (i >= seg.a && i <= seg.b) return true;
        }
        return false;
      }

      // Purple background blocks behind locked segments (kept)
      if (mode === "epi") {
        ctx.save();
        ctx.globalAlpha = epiHi ? 0.28 : 0.20;
        ctx.fillStyle = "rgba(170, 90, 255, 1)";
        const x0 = cx - (turns*pitch)/2;
        for (const seg of lockSegments){
          const xa = x0 + seg.a*pitch - pitch*0.6;
          const xb = x0 + seg.b*pitch + pitch*0.6;
          roundRect(xa, cy - amp*1.35, (xb-xa), amp*2.7, 16, true, false);
        }
        ctx.restore();
      }

      for (let i=0;i<turns;i++){
        const t = i*0.55 + tNow;
        const x = cx - (turns*pitch)/2 + i*pitch;
        const y1 = cy + amp*Math.sin(t);
        const y2 = cy + amp*Math.sin(t + Math.PI);

        const inGene = (i>=geneStart && i<=geneEnd);
        const locked = isLocked(i);

        let rungColor = "rgba(255,255,255,0.20)";
        let rungWidth = 2.0;

        if (geneHi && inGene) { rungColor = "rgba(0,255,140,0.92)"; rungWidth = 3.0; }
        else if (baseHi && (i%4===0)) { rungColor = "rgba(255,255,255,0.92)"; rungWidth = 3.0; }

        if (mode === "epi" && locked) {
          rungColor = epiHi ? "rgba(230, 200, 255, 0.95)" : "rgba(230, 200, 255, 0.55)";
          rungWidth = epiHi ? 3.0 : 2.2;
        }

        ctx.save();
        ctx.strokeStyle = rungColor;
        ctx.lineWidth = rungWidth;
        ctx.beginPath();
        ctx.moveTo(x,y1);
        ctx.lineTo(x,y2);
        ctx.stroke();
        ctx.restore();

        let backboneColor = "rgba(255,255,255,0.55)";
        if (geneHi && inGene) backboneColor = "rgba(0,255,140,0.65)";
        if (mode === "epi" && locked) backboneColor = epiHi ? "rgba(190, 120, 255, 0.80)" : "rgba(190, 120, 255, 0.50)";

        glowCircle(x, y1, 5.0, backboneColor, 18);
        glowCircle(x, y2, 5.0, backboneColor, 18);

        if (mode === "epi" && locked && (i % 3 === 0)) {
          ctx.save();
          ctx.font = "900 14px system-ui";
          ctx.fillStyle = epiHi ? "rgba(255,255,255,0.92)" : "rgba(255,255,255,0.70)";
          ctx.shadowColor = "rgba(190,120,255,0.55)";
          ctx.shadowBlur = 16;
          ctx.fillText("üîí", x - 7, (0.5*(y1+y2)) + 5);
          ctx.restore();
        }
      }
    }

    // ============================================================
    // Polymer worlds for acts 4‚Äì7 (UNCHANGED)
    // ============================================================
    const world = {
      initialised: false,
      beads: [],
      bvx: [],
      bvy: [],
      tfs: [],
      frame: 0
    };

    const P = {
      beadCount: 210,
      restLen: 9,
      kSpring: 0.18,
      kBend: 0.010,
      damping: 0.92,
      brownian: 0.18,
      beadR: 4.6,
      repelK: 0.55
    };

    const bigTF = { x: 0, y: 0, vx: 0, vy: 0, radius: 34 };
    let draggingTF = false;
    let dragOffset = {x:0, y:0};

    let draggingBead = { active:false, idx:-1 };
    let beadDragK = 0.020;

    function mouseToCanvas(e){
      const rect = canvas.getBoundingClientRect();
      const sx = (e.clientX - rect.left);
      const sy = (e.clientY - rect.top);
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      return { x: sx * scaleX, y: sy * scaleY };
    }
    function pointerPos(e){ return mouseToCanvas(e); }

    function findNearestBead(px, py, maxDist){
      let best = {idx:-1, d2: maxDist*maxDist};
      for (let i=0;i<world.beads.length;i++){
        const b = world.beads[i];
        const dx = b.x - px, dy = b.y - py;
        const d2 = dx*dx + dy*dy;
        if (d2 < best.d2){
          best = {idx:i, d2};
        }
      }
      return best.idx;
    }

    canvas.addEventListener("pointerdown", (e) => {
      const p = pointerPos(e);

      if (mode === "act6"){
        const dx = p.x - bigTF.x;
        const dy = p.y - bigTF.y;
        if (Math.sqrt(dx*dx+dy*dy) < bigTF.radius*1.15){
          draggingTF = true;
          dragOffset.x = dx;
          dragOffset.y = dy;
          canvas.setPointerCapture(e.pointerId);
          return;
        }
      }

      if (mode === "act4"){
        const idx = findNearestBead(p.x, p.y, 26);
        if (idx !== -1){
          draggingBead.active = true;
          draggingBead.idx = idx;
          canvas.setPointerCapture(e.pointerId);
        }
      }
    });

    canvas.addEventListener("pointermove", (e) => {
      const p = pointerPos(e);

      if (draggingTF){
        bigTF.x = p.x - dragOffset.x;
        bigTF.y = p.y - dragOffset.y;
        return;
      }
      lastPointer.x = p.x;
      lastPointer.y = p.y;
    });

    canvas.addEventListener("pointerup", () => {
      draggingTF = false;
      draggingBead.active = false;
      draggingBead.idx = -1;
    });
    canvas.addEventListener("pointercancel", () => {
      draggingTF = false;
      draggingBead.active = false;
      draggingBead.idx = -1;
    });

    const lastPointer = {x:0,y:0};

    let bigTFs = [];

    function initActWorld(force=false){
      const polymerModes = ["act4","act5","act6","act7"];
      if (!polymerModes.includes(mode)) return;

      if (world.initialised && !force) return;

      world.initialised = true;
      world.frame = 0;
      resizeCanvas();
      const W = canvas.width, H = canvas.height;

      world.beads = [];
      world.bvx = new Array(P.beadCount).fill(0);
      world.bvy = new Array(P.beadCount).fill(0);

      const startX = W * 0.10;
      const midY = H * 0.56;

      for (let i=0;i<P.beadCount;i++){
        const x = startX + i*P.restLen;
        const y = midY + (H*0.06)*Math.sin(i*0.17) + (H*0.02)*randn();
        world.beads.push({x,y});
      }

      if (mode === "act4"){
        const a1 = {x: W*0.44, y: H*0.50};
        const a2 = {x: W*0.60, y: H*0.62};

        for (let i=0;i<P.beadCount;i++){
          const p = world.beads[i];
          const t = i/(P.beadCount-1);

          const w1 = Math.exp(-Math.pow((t-0.25)/0.14,2));
          const w2 = Math.exp(-Math.pow((t-0.50)/0.14,2));
          const w3 = Math.exp(-Math.pow((t-0.75)/0.14,2));

          const ax = a1.x*w1 + a2.x*w2 + a1.x*w3;
          const ay = a1.y*w1 + a2.y*w2 + a1.y*w3;

          const w = 0.55*(w1+w2+w3);
          p.x = p.x*(1-w) + ax*w;
          p.y = p.y*(1-w) + ay*w;
        }
        for (let i=0;i<P.beadCount;i++){
          const p = world.beads[i];
          const t = i/(P.beadCount-1);
          p.y += (H*0.05)*Math.sin(10*t);
        }
      }

      world.tfs = [];
      if (mode === "act5"){
        for (let i=0;i<36;i++){
          world.tfs.push({
            x: W*(0.20 + 0.60*Math.random()),
            y: H*(0.20 + 0.60*Math.random()),
            vx: 0, vy: 0
          });
        }
      }

      if (mode === "act6"){
        bigTF.x = W*0.60;
        bigTF.y = H*0.56;
        bigTF.vx = 0; bigTF.vy = 0;
      }

      if (mode === "act7"){
        bigTF.x = W*0.58;
        bigTF.y = H*0.54;
        bigTF.vx = 0; bigTF.vy = 0;

        const center = {x: bigTF.x, y: bigTF.y};
        const R0 = bigTF.radius * 1.10;
        const R1 = bigTF.radius * 3.8;
        for (let i=0;i<P.beadCount;i++){
          const t = i/(P.beadCount-1);
          const w = Math.exp(-Math.pow((t-0.52)/0.22,2));
          if (w < 0.12) continue;

          const angle = (i*0.36);
          const r = (R0 + (R1-R0)*(0.5+0.5*Math.sin(i*0.07))) * (0.6 + 0.5*w);
          const targetX = center.x + r*Math.cos(angle);
          const targetY = center.y + r*Math.sin(angle);

          world.beads[i].x = world.beads[i].x*(1-w) + targetX*w;
          world.beads[i].y = world.beads[i].y*(1-w) + targetY*w;
        }

        bigTFs = [];
        const count = 6;
        for (let i=0;i<count;i++){
          bigTFs.push({
            x: W*(0.12 + 0.76*Math.random()),
            y: H*(0.18 + 0.64*Math.random()),
            vx: 0, vy: 0,
            radius: 26 + 6*Math.random()
          });
        }
      }
    }

    function springForce(ax, ay, bx, by, rest, k){
      const dx=bx-ax, dy=by-ay;
      const r=Math.sqrt(dx*dx+dy*dy)+1e-6;
      const f=k*(r-rest);
      return {fx:f*dx/r, fy:f*dy/r};
    }
    function bendForce(p0,p1,p2,kB){
      const mx=0.5*(p0.x+p2.x);
      const my=0.5*(p0.y+p2.y);
      return {fx:kB*(mx-p1.x), fy:kB*(my-p1.y)};
    }
    function repelPair(ax, ay, bx, by, minDist, k){
      const dx=bx-ax, dy=by-ay;
      const r2=dx*dx+dy*dy+1e-6;
      const r=Math.sqrt(r2);
      if (r>=minDist) return {fx:0, fy:0};
      const overlap=minDist-r;
      const f=k*overlap;
      return {fx:f*dx/r, fy:f*dy/r};
    }
    function softWalls(x,y,vx,vy){
      const W=canvas.width, H=canvas.height;
      const margin=70;
      const k=0.0018;
      if (x<margin) vx += k*(margin-x);
      if (x>W-margin) vx -= k*(x-(W-margin));
      if (y<margin) vy += k*(margin-y);
      if (y>H-margin) vy -= k*(y-(H-margin));
      return {vx,vy};
    }

    function multivalentWrapForce(p, tf){
      const dx=tf.x - p.x;
      const dy=tf.y - p.y;
      const d=Math.sqrt(dx*dx+dy*dy)+1e-6;

      const attractR = tf.radius * 4.2;
      const repelR   = tf.radius * 1.10;

      let fx=0, fy=0;
      if (d < repelR){
        const push = (repelR - d) * 0.10;
        fx -= push * dx/d;
        fy -= push * dy/d;
      } else if (d < attractR){
        const s = (1 - d/attractR);
        const pull = 0.010 * s;
        fx += pull * dx;
        fy += pull * dy;
      }
      return {fx, fy};
    }

    function stepPolymer(){
      world.frame++;
      const n = P.beadCount;

      for (let i=0;i<n-1;i++){
        const a=world.beads[i], b=world.beads[i+1];
        const f=springForce(a.x,a.y,b.x,b.y,P.restLen,P.kSpring);
        world.bvx[i] += f.fx; world.bvy[i] += f.fy;
        world.bvx[i+1] -= f.fx; world.bvy[i+1] -= f.fy;
      }
      for (let i=1;i<n-1;i++){
        const f=bendForce(world.beads[i-1], world.beads[i], world.beads[i+1], P.kBend);
        world.bvx[i] += f.fx;
        world.bvy[i] += f.fy;
      }

      const minBB = 2*P.beadR;
      for (let i=0;i<n;i++){
        const i0=Math.max(0,i-14);
        const i1=Math.min(n-1,i+14);
        for (let j=i0;j<=i1;j++){
          if (j===i) continue;
          if (Math.abs(i-j)<=1) continue;
          const a=world.beads[i], b=world.beads[j];
          const f=repelPair(a.x,a.y,b.x,b.y,minBB,0.55);
          world.bvx[i] -= f.fx; world.bvy[i] -= f.fy;
          world.bvx[j] += f.fx; world.bvy[j] += f.fy;
        }
      }

      if (mode === "act4" && draggingBead.active && draggingBead.idx >= 0){
        const i = draggingBead.idx;
        const b = world.beads[i];
        const dx = (lastPointer.x - b.x);
        const dy = (lastPointer.y - b.y);
        world.bvx[i] += beadDragK * dx;
        world.bvy[i] += beadDragK * dy;
      }

      if (mode === "act6"){
        for (let i=0;i<n;i++){
          const p=world.beads[i];
          const f = multivalentWrapForce(p, bigTF);
          world.bvx[i] += f.fx;
          world.bvy[i] += f.fy;
        }
      }

      let brown = 0.16;
      if (mode === "act4") brown = 0.22;
      if (mode === "act5") brown = 0.02;
      if (mode === "act6") brown = 0.14;
      if (mode === "act7") brown = 0.006;

      for (let i=0;i<n;i++){
        world.bvx[i] += brown*randn();
        world.bvy[i] += brown*randn();
        world.bvx[i] *= P.damping;
        world.bvy[i] *= P.damping;

        world.beads[i].x += world.bvx[i];
        world.beads[i].y += world.bvy[i];

        const out=softWalls(world.beads[i].x, world.beads[i].y, world.bvx[i], world.bvy[i]);
        world.bvx[i]=out.vx; world.bvy[i]=out.vy;
      }

      if (mode === "act5"){
        const W=canvas.width, H=canvas.height;
        for (const tf of world.tfs){
          tf.vx += 0.55*randn();
          tf.vy += 0.55*randn();
          tf.vx *= 0.93;
          tf.vy *= 0.93;
          tf.x += tf.vx;
          tf.y += tf.vy;
          if (tf.x<0) tf.x += W;
          if (tf.x>W) tf.x -= W;
          if (tf.y<0) tf.y += H;
          if (tf.y>H) tf.y -= H;
        }
      }

      if (mode === "act7"){
        const W=canvas.width, H=canvas.height;
        const target = {x: bigTF.x, y: bigTF.y};
        for (const tf of bigTFs){
          tf.vx += 0.12*randn();
          tf.vy += 0.12*randn();

          tf.vx += 0.0016*(target.x - tf.x);
          tf.vy += 0.0016*(target.y - tf.y);

          tf.vx *= 0.88;
          tf.vy *= 0.88;
          tf.x += tf.vx;
          tf.y += tf.vy;

          if (tf.x<0) tf.x += W;
          if (tf.x>W) tf.x -= W;
          if (tf.y<0) tf.y += H;
          if (tf.y>H) tf.y -= H;
        }
      }
    }

    function drawPolymerAndTFs(){
      ctx.save();
      ctx.strokeStyle = "rgba(255,255,255,0.22)";
      ctx.lineWidth = 3.0;
      ctx.beginPath();
      world.beads.forEach((p,i)=>{
        if(i===0) ctx.moveTo(p.x,p.y);
        else ctx.lineTo(p.x,p.y);
      });
      ctx.stroke();
      ctx.restore();

      for (const p of world.beads){
        glowCircle(p.x,p.y, 4.6, "rgba(255,255,255,0.52)", 15);
      }

      if (mode === "act5"){
        for (const tf of world.tfs){
          glowCircle(tf.x, tf.y, 6.2, "rgba(255,60,60,0.65)", 20);
        }
      }

      if (mode === "act6"){
        ctx.save();
        ctx.globalCompositeOperation = "lighter";
        glowCircle(bigTF.x, bigTF.y, bigTF.radius*5.0, "rgba(255,120,200,0.020)", 160);
        glowCircle(bigTF.x, bigTF.y, bigTF.radius*2.6, "rgba(255,60,60,0.020)", 120);
        ctx.restore();

        glowCircle(bigTF.x, bigTF.y, bigTF.radius, "rgba(255,60,60,0.92)", 40);
      }

      if (mode === "act7"){
        ctx.save();
        ctx.globalCompositeOperation = "lighter";
        glowCircle(bigTF.x, bigTF.y, bigTF.radius*5.2, "rgba(255,120,200,0.018)", 170);
        glowCircle(bigTF.x, bigTF.y, bigTF.radius*2.8, "rgba(255,60,60,0.018)", 130);
        ctx.restore();

        glowCircle(bigTF.x, bigTF.y, bigTF.radius, "rgba(255,60,60,0.92)", 44);

        for (const tf of bigTFs){
          glowCircle(tf.x, tf.y, tf.radius, "rgba(255,60,60,0.55)", 28);
        }
      }
    }

    // ============================================================
    // Main tick
    // ============================================================
    function tick(){
      resizeCanvas();

      // If we're showing overlay-only acts, don't run canvas animation
      if (mode === "act1_overlay"){
        requestAnimationFrame(tick);
        return;
      }

      // Final image act
      if (mode === "act8_img"){
        requestAnimationFrame(tick);
        return;
      }

      drawBackground();

      if (mode === "dna" || mode === "epi"){
        drawDNAHelix();
      } else if (mode === "act4" || mode === "act5" || mode === "act6" || mode === "act7"){
        initActWorld(false);
        stepPolymer();
        drawPolymerAndTFs();
      }

      requestAnimationFrame(tick);
    }

    // ============================================================
    // Init / resize
    // ============================================================
    window.addEventListener("resize", () => {
      resizeCanvas();
      initActWorld(true);
    });

    resizeCanvas();
    applyAct(0);
    tick();
  </script>
</body>
</html>



















